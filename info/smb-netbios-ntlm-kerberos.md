## What is SMB
 
Server Message Block (SMB) operates as an __Application-layer network protocol mainly used for providing shared access to files, printers, and serial ports__ and miscellaneous communications between nodes on a network. It also provides an authenticated inter-process communication mechanism. Most usage of SMB involves computers running Microsoft Windows.
 
__SMB was originally designed to run on top of the NetBIOS API.__ 

__NetBIOS__ is an acronym for Network Basic Input/Output System. It provides services related to the session layer of the OSI model __allowing applications on separate computers to communicate over a local area network. NetBIOS is not a networking protocol and strictly is an API.__
 
## How SMB Authentication works
 
SMB uses NTLM protocol for authentication.
NTLM is a challenge-response authentication protocol.

The Microsoft Kerberos security package adds greater security than NTLM to systems on a network. Although Microsoft Kerberos is the protocol of choice, NTLM is still supported.

__NTLM uses an encrypted challenge/response protocol to authenticate a user without sending the user's password over the wire.__

### NT Lan Manager(NTLM) Working
 
1. Client initiates authentication request
2. Server responds with a challenge/nonce. The challenge is a 8-byte number which must be unpredictable.
3. Client and server both have a shared secret.
4. Client computes the response which is a function of secret and challenge. Mathematically, Response R=f(secret, challenge)
5. client sends the response to server.
6. server also calculates the response and matches it with the recieved response.
7. In this way, the client can be authenticated without actually transmitting the secret over unsecured channels.

## Problems with NTLM (SMB v1 and SMB v2 vulnerabilities)
 
It was found that the challenges generated are not unique and are repeating in a very short period (2 seconds while doing attack) of time. Thus, an attacker can predict the challenges or built a dictionary of challenge-response.

NOTE - In all these attacks, we are not letting any connection open. We are just connecting and then disconnecting over and again.
In SmbRelay attacks, the sessions are kept open unlike this situation.

1. __Passive replay attack__

If challenges are repeated one can eavesdrop on the traffic and built a dictionary of challenge-response to get unauthorized access to server.
An attacker can repeatedly make authentication requests to server until it gets the challenge which is there in the attacker's dictionary.
This attack is called passive replay attack.

To mitigate this vulnerability a new timestamp field was introduced in client responses. It makes old generated responses invalidated as their timestamp becomes older and the server can differnetiate between the recently generated and a month older responses. Thus, an attacker cannot use a month older responses.
        
2. __Active collection of duplicate challenges (mainly used)__
 
In this attack, the attacker actively collects challenges which are repeating in a short period of time from the server by repeatedly sending the authentication packet to the sever. The attacker then starts building up the dictionary.

The attacker makes the client to connect to him and when one connects to it, the attacker presents the client with the challenges collected in the previous step and gathers the corresponding responses to complete the dictionary.

3. __Active prediction of challenges__

When an attacker can predict the challenge it can pretend to be the server to client and send the challenge to client which is to be generated by the server next. Now, attacker will get the response from the client which it can use to authenticate itself to the real server.

